<%@ page import='com.freshdirect.fdstore.content.CategoryModel' %>
<%@ page import='com.freshdirect.fdstore.content.util.SortStrategyElement' %>
<%@ page import='com.freshdirect.webapp.taglib.fdstore.layout.LayoutManager.Settings' %>
<%@ page import='com.freshdirect.webapp.util.*' %>

<%@ taglib uri="/WEB-INF/shared/tld/fd-display.tld" prefix='display' %>

<%

	int tempCounter=0;
	rowColl = new ArrayList();
	sortedColl = null; 
	onlyOneProduct = false;
	theOnlyProduct = null;
	currentFolder = ContentFactory.getInstance().getContentNodeByName(catId);
	isDept = (currentFolder instanceof DepartmentModel);
	isCat = (currentFolder instanceof CategoryModel);
	trkCode= "";
	boolean usePerRowLimit = true;
	boolean useRowLimit = true;
	usePerRowLimit = (perRow>0)?true:false;
	useRowLimit = (maxRows>0)?true:false;
	int maxToShow = 0;

	maxToShow = (useRowLimit) ? perRow*maxRows : 999999999;


/* pass the code that should be used as the tracking code */
if (isDept) {
	trkCode = "dpage";
	request.setAttribute("trk","dpage");
} else if(isCat) {
	trkCode = "cpage";
    request.setAttribute("trk","cpage");
}
sortDescending = "true".equalsIgnoreCase(request.getParameter("sortDescending"));
sortNameAttrib = currentFolder.getAttribute("LIST_AS", "full");
    
layoutSettings = new Settings();
layoutSettings.setGrabberDepth(0);
layoutSettings.setIgnoreDuplicateProducts(true);
layoutSettings.setIgnoreShowChildren(false);
layoutSettings.addSortStrategyElement(new SortStrategyElement(SortStrategyElement.PRODUCTS_BY_PRIORITY, false));
layoutSettings.setReturnHiddenFolders(false);

List tmpList=new ArrayList();
%>
<% log(myDebug, "-=-=-=-=-= in generic row currentFolder : "+currentFolder); %>
<% log(myDebug, "-=-=-=-=-= in generic row isDept : "+isDept); %>
<% log(myDebug, "-=-=-=-=-= in generic row isCat : "+isCat); %>

<fd:ItemGrabber
	category='<%=currentFolder %>' 
	id='rtnColl' 
	depth='<%=layoutSettings.getGrabberDepth()%>'
	ignoreShowChildren='<%=layoutSettings.isIgnoreShowChildren()%>' 
	filterDiscontinued='<%= layoutSettings.isFilterDiscontinued() %>'
	returnHiddenFolders='<%=layoutSettings.isReturnHiddenFolders()%>'
	ignoreDuplicateProducts='<%=layoutSettings.isIgnoreDuplicateProducts()%>'
	returnSecondaryFolders='<%=layoutSettings.isReturnSecondaryFolders()%>' 
	returnSkus='<%=layoutSettings.isReturnSkus()%>'
	workSet='<%=tmpList%>'
>
<%
        sortedColl = rtnColl;
        
        request.setAttribute("itemGrabberResult",sortedColl); //** expose result of item grabber to the layout **
		
		log(myDebug, "-=-=-=-=-= in generic row ItemGrabber layoutSettings.isIgnoreDuplicateProducts() : "+layoutSettings.isIgnoreDuplicateProducts());
%>
    </fd:ItemGrabber> 
 
    <fd:ItemSorter nodes='<%=(List)sortedColl%>' strategy='<%=layoutSettings.getSortStrategy()%>'/>

	<logic:iterate id="contentNode" collection="<%= sortedColl %>" type="java.lang.Object" indexId="idx">
		<%
				log(myDebug, "-=-=-=-=-= in generic row maxToShow1 "+maxToShow);
				log(myDebug, "-=-=-=-=-= in generic row tempCounter1 "+tempCounter);
			// skip if more than 5, is a category or already used on page
			if (tempCounter >= maxToShow || (contentNode instanceof CategoryModel) || globalColl.contains(contentNode)) { continue; }
			ProductModel pm = (ProductModel) contentNode;
			//skip if discontinued or unavailable
			if (pm.isDiscontinued() || pm.isUnavailable()) { continue; }

			//add to global collection for dupe check
			globalColl.add(contentNode);
			//add to pageColl for prices ref
			rowColl.add(contentNode);

			tempCounter++;
		%>
	</logic:iterate>

	<%
		//rowColl should now have the collection of products to use

		//if we have any items to show, display them
		if (rowColl.size() > 0) {
	%>
		<fd:IncludeMedia name="/media/editorial/whats_good/whats_good_line.html" />
		<% mediaPath = "/media/editorial/whats_good/whats_good_"+ catId + "_above.html"; %>
		<fd:IncludeMedia name="<%=mediaPath%>" />

		<table cellpadding="0" cellspacing="0" border="0">
		<tr valign="bottom">

			<% log(myDebug, "-=-=-=-=-= in generic row rowColl : "+catId+" : "+(List)rowColl); %>
			<logic:iterate id="contentNode" collection="<%= rowColl %>" type="java.lang.Object" indexId="idx">

			<%
				log(myDebug, "-=-=-=-=-= in generic row contentNode : "+contentNode);
				log(myDebug, "-=-=-=-=-= in generic row instanceof CategoryModel : "+(contentNode instanceof CategoryModel));
				log(myDebug, "-=-=-=-=-= in generic row instanceof globalColl.contains : "+globalColl.contains(contentNode));
				
				//we don't need checks here, we did it previously

				ProductModel pm = (ProductModel) contentNode;
				String prodNameAttribute = JspMethods.getProductNameToUse(pm);
				DisplayObject displayObj = JspMethods.loadLayoutDisplayStrings(response,catId,pm,prodNameAttribute,false);
				int adjustedImgWidth = displayObj.getImageWidthAsInt()+6+10;
				String actionURI = FDURLUtil.getProductURI( pm, trkCode );			
			%>

				<td align="center" width="<%=adjustedImgWidth%>" style="padding-left:5px; padding-right:5px;">
					<display:ProductImage product="<%= pm %>" showRolloverImage="false" action="<%= actionURI %>" />
				</td>
			
			</logic:iterate>
		</tr>
		<tr>
			<logic:iterate id="contentNode" collection="<%= rowColl %>" type="java.lang.Object" indexId="idx">
			<%

				log(myDebug, "-=-=-=-=-= in generic row contentNode2 : "+contentNode);
				log(myDebug, "-=-=-=-=-= in generic row contentNode2 : "+(contentNode instanceof CategoryModel));
				log(myDebug, "-=-=-=-=-= in generic row instanceof globalColl.contains2 : "+rowColl.contains(contentNode));

				ProductModel pm = (ProductModel) contentNode;
				String prodNameAttribute = JspMethods.getProductNameToUse(pm);
				DisplayObject displayObj = JspMethods.loadLayoutDisplayStrings(response,catId,pm,prodNameAttribute,true);
				int adjustedImgWidth = displayObj.getImageWidthAsInt()+6+10;
				String actionURI = FDURLUtil.getProductURI( pm, trkCode );
			%>

				<td valign="top" width="<%=adjustedImgWidth%>" align="center" style="padding-left:5px; padding-right:5px;padding-bottom:10px;">
					<div class="WG_deals">
						<display:ProductRating product="<%= pm %>" action="<%= actionURI %>" />
						<display:ProductName product="<%= pm %>" action="<%= actionURI %>" />
						<display:ProductPrice impression="<%= new ProductImpression(pm) %>" showDescription="false" />
					</div>
				</td>
			</logic:iterate>
		</tr>
		</table>
	<%
		}
	%>
	
	<% log(myDebug, "-=-=-=-=-= in generic row END : "); %>