<%@ page import='java.util.*'
%><%@ page import='com.freshdirect.fdstore.customer.*'
%><%@ page import="com.freshdirect.fdstore.*"
%><%@ page import='com.freshdirect.webapp.taglib.fdstore.*'
%><%@ page import='com.freshdirect.fdstore.content.*'
%><%@ page import='com.freshdirect.fdstore.promotion.*'
%><%@ page import='com.freshdirect.cms.fdstore.FDContentTypes'
%><%@ page import="com.freshdirect.webapp.util.FDEventUtil"
%><%@ page import="com.freshdirect.smartstore.fdstore.Recommendations"
%><%@ page import="com.freshdirect.smartstore.fdstore.FDStoreRecommender"
%><%@ page import="com.freshdirect.smartstore.Trigger"
%><%@ page import="com.freshdirect.fdstore.util.EnumSiteFeature"
%><%@ page import="com.freshdirect.webapp.util.ConfigurationStrategy"
%><%@ page import="com.freshdirect.webapp.util.ConfigurationContext"
%><%@ page import="com.freshdirect.webapp.util.ProductImpression"
%><%@ page import="com.freshdirect.webapp.util.ProductLabelling"
%><%@ page import="com.freshdirect.webapp.util.TransactionalProductImpression"
%><%@ page import="com.freshdirect.webapp.util.FDURLUtil"
%><%@ page import="com.freshdirect.webapp.util.prodconf.SmartStoreConfigurationStrategy"
%><%@ page import="com.freshdirect.framework.webapp.ActionResult"
%><%@ page import="com.freshdirect.framework.webapp.ActionError"
%><%@ page import="java.net.URLEncoder"
%><%@ page import="com.freshdirect.webapp.util.ConfigurationUtil"
%><%@ page import="com.freshdirect.webapp.util.RequestUtil"
%><%@ page import="com.freshdirect.smartstore.fdstore.SmartStoreUtil"
%><%@ page import="com.freshdirect.smartstore.Variant"
%><%@ page import="com.freshdirect.cms.ContentKey"
%><%@ page import="org.apache.commons.lang.StringEscapeUtils"
%><%@ taglib uri='template' prefix='tmpl'
%><%@ taglib uri='logic' prefix='logic'
%><%@ taglib uri='freshdirect' prefix='fd'
%><%
// SMARTSTORE - DYF Template
// -------------------------
//
// @author segabor
//
// @input user instance of {@link FDUserI}
// @input result {@link ActionResult} errors returned by FDShoppingCartController
//
Object val = request.getAttribute("skipDYFCheck");
boolean skipDYFCheck = (val instanceof Boolean && ((Boolean)val).booleanValue() );

// Transactional
final java.text.DecimalFormat QUANTITY_FORMATTER = new java.text.DecimalFormat("0.##");
final java.text.NumberFormat CURRENCY_FORMATTER = java.text.NumberFormat.getCurrencyInstance(Locale.US);



// transactional pricing logic - 'template' parameters
final String tx_pricing_FormName = "dyfform"; // impression form name
final String tx_pricing_JSNameSpace = "DYF";

String formUri = request.getRequestURI();

if (request.getAttribute("is_ajax") != null) {
	formUri = request.getParameter("formUri");
} else {
%>

<br/><br/>
<script>
function dyf_ajax_failureCallback() {
	alert("Failed to retrieve new recommendations.");
	document.getElementById('dyf_ajax_rotateLinkContainer').innerHTML = '<a href="#" onclick="dyf_ajax_execute();return false;">Click here to refresh</a>';
}

function dyf_ajax_successCallback(resp) {
	document.getElementById('placeHolder').innerHTML = resp.responseText;
	dyf_ajax_runScripts(document.getElementById('placeHolder'));
}
 
function dyf_ajax_runScripts(e) {
	if (e.nodeType != 1) return;
 
	if (e.tagName.toLowerCase() == 'script') {
		eval(e.text);
	}
	else {
		var n = e.firstChild;
		while ( n ) {
			if ( n.nodeType == 1 ) dyf_ajax_runScripts( n );
			n = n.nextSibling;
		}
	}
}

function dyf_ajax_execute() {
	document.getElementById('dyf_ajax_rotateLinkContainer').innerHTML = '<span style="color: gray;font-style: italic;">Refreshing...</span>';
	var callback = 
		{ 
			success: dyf_ajax_successCallback, 
			failure: dyf_ajax_failureCallback 
		}; 
	var request = YAHOO.util.Connect.asyncRequest('GET', "/ajax/dyf.jsp?formUri=<%= URLEncoder.encode(formUri) %>", callback); 	
}
</script>
<div id="placeHolder">
<%
} // end of if is_ajax

if (request.getParameter("nodyf") == null) {
%>
<fd:DYFRecommendations id="recommendations" skipCheck="<%= skipDYFCheck %>" errorOccurred="<%= !result.isSuccess() %>"><%
	// List of recommendations
	ConfigurationContext confContext = new ConfigurationContext();
	confContext.setFDUser(user);
	boolean hasAnyItemAddable = false;
	if (recommendations != null && recommendations.getProducts().size() > 0) {
        request.setAttribute("recommendationsRendered","true");
		ConfigurationStrategy cUtil = SmartStoreConfigurationStrategy.getInstance();

		List products = recommendations.getProducts();
		
		// List<ProductImpression> impressions : configured products enlisted in 'Your Favourites' table
		List impressions = new ArrayList();

		// List<SkuModel> skus : SKUs required by the pricing engine
		List skus = new ArrayList();



		// 'configure' products.
		for (Iterator it = products.iterator(); it.hasNext();) {
			ProductModel prd = (ProductModel) it.next();
			ProductImpression pi = cUtil.configure(prd, confContext);
			if (pi.isTransactional())
				hasAnyItemAddable = true;

			// post-post filter: ensure impression won't crash the display
			// if (pi.validate()) {
				impressions.add(pi);
				skus.add(pi.getSku());
			// }
		}

		// vprez := {variant label, variant text}
		String[] vprez = SmartStoreUtil.getVariantPresentation(recommendations.getVariant());


		/**
		 * Pricing Engine (JavaScript)
		 *
		 * Input: List<SkuModel> skus
		 */
%>
<a name="cartRec"></a>
<form name="<%= tx_pricing_FormName %>" method="post" action="<%= formUri %>" style="margin:0px">
	<input type="hidden" name="fdsc.action" value="addMultipleToCart"/>
	<input type="hidden" name="fdsc.succpage" value="<%= formUri %>?confirm=1"/>
	<input type="hidden" name="fdsc.source"  value="SS"/>

	<input type="hidden" name="variant" value="<%=recommendations.getVariant().getId()%>">
	<input type="hidden" name="siteFeature" value="<%=recommendations.getVariant().getSiteFeature().getName()%>">
	<input type="hidden" name="rec_product_ids" value="<%=StringEscapeUtils.escapeHtml(recommendations.serializeContentNodes())%>">
	<input type="hidden" name="trk" value="<%= recommendations.getVariant().getSiteFeature().getName().toLowerCase() %>">

<!-- PRICING -->
<fd:TxProductPricingSupport formName="<%= tx_pricing_FormName %>" namespace="<%= tx_pricing_JSNameSpace %>" customer="<%= user %>" impressions="<%= impressions %>" inputNamePostfix="dyf"/>
<table class="smartstore" cellspacing="0" cellpadding="0" width="693" align="center">
<tr>
	<td width="6" colspan="2"><img width="6" height="24" src="/media_stat/images/layout/prpl_tp_lft.gif"></td>
	<td class="caption1" width="681" align="center">
		<%= vprez[0] %>
	</td>
	<td width="6" colspan="2"><img width="6" height="24" src="/media_stat/images/layout/prpl_tp_rht.gif"></td>
</tr>
<tr>
<td width="2" bgcolor="#996699"></td>
<td width="4"></td>
<td>
<fd:PIPLayout id="piRow" rowSize="5" impressions="<%= impressions %>" maxRowHeight="rowHeight" singleRowMode="<%= true %>">
	<div class="body1" id="recPanelBody">
	<table style="width: 100%;">
	<tr>
		<td colspan="<%= piRow.size() %>" style="text-align: center;padding-top: 5px; padding-bottom: 5px;">
			<span class="text11bold"><%= vprez[1] %></span>
		</td>
	</tr>
<%
	// ERROR DISPLAY
	//
	if (result.isFailure()) {
		%><tr>
			<td colspan="<%= piRow.size() %>" style="text-align: center; font-weight: bold; color: red;">
<%
		for (Iterator it=((Collection)result.getErrors()).iterator(); it.hasNext();) {
			ActionError err = (ActionError) it.next();
			
			// filter out unwanted error message types
			if (!"order_minimum".equalsIgnoreCase(err.getType())) {
%>
						<%= err.getDescription() %><br/>
<%
			}
		}
%>
			</td>
		</tr><%
	}


	int txProdCount = 0; // transactional products counter
	int colCount = 0;
	int rank=1;
%>
	<tr>
	<fd:PIPRow id="pi" impressionRow="<%= piRow %>" isBlankCell="isBlankCell" productImage="prodImage" shouldRenderBlankCells="<%= false %>">
<%
		// product cell
		//
		ProductModel product = pi.getProductModel();
		ProductLabelling pl = new ProductLabelling(user, product);
		pl.setHideYourFave(true);
		String actionURI = FDURLUtil.getProductURI(product, recommendations.getVariant().getId(), recommendations.getVariant().getSiteFeature().getName().toLowerCase(), pl.getTrackingCode(), rank);

		// cell renderning starts here		
%>
		<td style="width: <%= 
		       Math.round(100.0/impressions.size()) %>%; text-align: center; <%= colCount == 0? "padding-left: 2px; padding-right: 2px;" :""%> <%= 
		       colCount == piRow.size() - 1 ? "padding-right:5px;" : "" %>" valign="top" >
			<!-- CELL CONTAINER -->
			<table align="center">
				<tr>
					<td style="padding: 0; height: <%= rowHeight.intValue() %>px; vertical-align: bottom; text-align: center">
						<fd:ProductImage product="<%= product %>" action="<%= actionURI %>" hideYourFave="true" />
					</td>
				</tr>
<%

			if (pi instanceof TransactionalProductImpression) {
%>				<tr>
					<td>
						<input type="hidden" name="trk_dyf_<%= txProdCount %>" value="<%= recommendations.getVariant().getSiteFeature().getName().toLowerCase() %>">
						<input type="hidden" name="variant_dyf_<%= txProdCount %>" value="<%= recommendations.getVariant().getId() %>"/>
						<input type="hidden" name="rank_dyf_<%= txProdCount %>" value="<%= rank %>"/>
						<% if (pl.getTrackingCode() != null) { %><input type="hidden" name="trkd_dyf_<%= txProdCount %>" value="<%= pl.getTrackingCode() %>"/><% } %>

						<fd:TxProductControl txNumber="<%= txProdCount %>" namespace="<%= tx_pricing_JSNameSpace %>" inputNamePostfix="dyf"  impression="<%= (TransactionalProductImpression) pi %>"/>
					</td>
				</tr>
<%
				// Count transactional products only
				txProdCount++;
			} else { // transactional items
%>				<tr>
					<td style="height: 28px; text-align: center; vertical-align: middle;">
						<span class="text8">(click name to buy)</span>
					</td>
				</tr>
<%
			} // !transactional
%>
			</table>

			<!-- product name, etc -->
			<fd:ProductRating product="<%= product %>"/>
			<fd:ProductName product="<%= product %>" action="<%= actionURI %>"/>
			<fd:ProductDescription impression="<%= pi %>"/>
		</td>
<% ++rank; %>
	</fd:PIPRow>
	</tr>



	</table>
	<table style="width: 100%;">
		<tr>
		<% if (products.size() >= 5) { %>
		<td style="text-align: left;">
			<span class="text11bold" id="dyf_ajax_rotateLinkContainer"><a href="#" onclick="dyf_ajax_execute();return false;">Click here to refresh</a></span>
		</td>
		<% } %>
		<td></td>
		<% if (hasAnyItemAddable) { %>
		<td style="text-align: right;">
		<input type="hidden" style="width:60px" name="total" value="" size="6" class="text11bold" onChange="" onFocus="blur()"/>
		<input type="hidden" name="itemCount" value="<%= txProdCount %>"/>
		<input type="image" name="addMultipleToCart" style="padding: 8px 0px; border: 0" src="/media_stat/images/template/confirmation/add_to_cart_purple.gif" alt="ADD SELECTED TO CART"/>
		</td>
		<% } %>
		</tr>
	</table>			
	</div>
</fd:PIPLayout>
</td>
<td width="4"></td>
<td width="2" bgcolor="#996699"></td>
</tr>
<tr>
	<td width="6" colspan="2" rowspan="2"><img width="6" height="6" src="/media_stat/images/layout/prpl_bm_lft.gif"></td>
	<td width="681">
		<div style="height: 4px; font-size: 0px;"></div>
	</td>
	<td width="6" colspan="2" rowspan="2"><img width="6" height="6" src="/media_stat/images/layout/prpl_bm_rht.gif"></td>
</tr>
<tr>
<td bgcolor="#996699"><div style="height: 2px; font-size: 0px;"></div></td>
</tr>
</table><!-- smartstore -->
<script type="text/javascript">
	<%= tx_pricing_JSNameSpace %>.updateTotal();
</script>
</form>
<%
	} // recommendations.getProducts().size() > 0
%></fd:DYFRecommendations><%
} // !nodyf

if (request.getAttribute("is_ajax") == null) {
%>
</div><!-- end of placeHolder -->
<%
}
%>
