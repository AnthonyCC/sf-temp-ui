<%@ page import="com.freshdirect.fdstore.util.URLGenerator" %>
<%@ page import="com.freshdirect.fdstore.util.EnumSiteFeature"%>
<%@ page import="com.freshdirect.webapp.taglib.smartstore.PIPTabTag"%>
<%@ page import="com.freshdirect.smartstore.TabRecommendation"%>
<%@ page import="com.freshdirect.fdstore.customer.FDUserI" %>
<%@ page import="com.freshdirect.webapp.taglib.fdstore.SessionName" %>
<%@ page import="com.freshdirect.smartstore.fdstore.SmartStoreUtil"%>
<%@page import="java.net.URLEncoder"%>
<%@page import="java.text.MessageFormat"%>
<%@page import="java.util.Collections"%>
<%@ page import="java.util.Date"%>
<%@ page import="java.util.Map"%>
<%@ taglib uri='template' prefix='tmpl'%>
<%@ taglib uri='logic' prefix='logic'%>
<%@ taglib uri='freshdirect' prefix='fd'%>
<%
	// pass cart operation result object to YMAL display (i_ymal_lists.jspf)
	request.setAttribute("actionResult", result);
	
	URLGenerator gen = new URLGenerator(request);
	String hideSavingsVarId = gen.get("hideSavingsVarId");
	if (hideSavingsVarId != null) {
		Map xNodes = (Map) session.getAttribute(SessionName.SMART_STORE_PREV_RECOMMENDATIONS);
		Object xRecs = xNodes.get(hideSavingsVarId);
		if (xRecs != null)
			xNodes.put(hideSavingsVarId, Collections.EMPTY_LIST);
		gen.remove("hideSavingsVarId");
		response.sendRedirect(StringEscapeUtils.unescapeHtml(gen.build()));
		return;
	}

	//TODO calculate tab sizes depending on number of tabs
	int totalWidth = 970;
	final String __uri = request.getRequestURI();
	if(__uri.indexOf("quickshop") > -1) {
		if (__uri.endsWith("index.jsp"))
			totalWidth = 740; // QS main page
		else
			totalWidth = 601; // QS inner pages
	}
%>
<fd:PIPTab id="tab" maxTabs="3" maxRecommendations="5" facility="<%= smartStoreFacility %>">
	<% 
		
		final int selectedTab = selectedTabIndex.intValue();
		final int numTabs = tab.size();
		int tabSize = numTabs==3 ? 300 : numTabs==2 ? 450 : 900;
		if (__uri.indexOf("quickshop") > -1) {
			tabSize = numTabs==3 ? 225 : numTabs==2 ? 340 : 680;
		}
		
		if ( numTabs > 0 ) { %>
	
			<%-- TABS ROW --%>
			<table width="<%= totalWidth %>px" height="25px" class="tab">
				<tr height="25px">
				
					<% for ( int k = 0; k < numTabs; k++ ) { 
		
							boolean selected = ( selectedTab == k );
							boolean prevSelected = ( selectedTab == k-1 );
							String varId = tab.get(k).getId();
							
							if ( k == 0 ) { // first tab %>				
								<td height="25px" width="8px" class="tab">
									<img id="img_<%= varId %>" alt="" src="/media_stat/images/carttab_corners/carttab_first_left_<%= selected?"on":"off" %>.gif" class="tab">
								</td>
							<% } else { %>					
								<td height="25px" width="16px" class="tab">
									<img id="img_<%= varId %>" alt="" src="/media_stat/images/carttab_corners/carttab_btwn_<%= prevSelected?"on":"off" %>_<%= selected?"on":"off" %>.gif" class="tab">
								</td>
							<% } %>
							
							
								<td id="td_<%= varId %>" vid="<%= varId %>" tpos="<%= k %>" height="25px" width="<%= tabSize %>px" class="tab_title_<%= selected?"active":"inactive" %>">
									<span class="tab_<%= selected?"active":"inactive" %>" id="a_<%= varId %>"><a href="/unsupported.jsp" class="tab"><%= tab.getTabTitle(k) %></a></span>
								</td>
							
							<% if ( k == numTabs-1 ) { // last tab %>					
								<td height="25px" width="16px" class="tab">
									<img id="img_last" alt="" src="/media_stat/images/carttab_corners/carttab_btwn_<%= selected?"on":"off" %>_nothing.gif" class="tab">
								</td>
								<td height="25px" width="<%= totalWidth - numTabs*(tabSize+16) - 16 %>px" background="/media_stat/images/carttab_corners/carttab_bg_empty.gif" class="tab">
								</td>
								<td height="25px" width="8px" class="tab">
									<img alt="" src="/media_stat/images/carttab_corners/carttab_cor_tr_1.gif" class="tab">							
								</td>
							<% } %>
					
					<% } %>
							
				</tr>
			</table>
		
			<table width="<%= totalWidth %>px" height="6px" class="tab">
				<tr height="6px">
					<td width="8px" height="6px" class="tab">
						<img alt="" src="/media_stat/images/carttab_corners/carttab_bg_left.gif" class="tab">
					</td>
					<td width="<%= totalWidth-16 %>px" height="6px" class="tab">
					</td>
					<td width="8px" height="6px" class="tab">
						<img alt="" src="/media_stat/images/carttab_corners/carttab_cor_tr_2.gif" class="tab">
					</td>
				</tr>
			</table>
			
			<table width="<%= totalWidth %>px" class="tab">
				<tr>
					<td class="tab"><div class="tab"><table width="100%"><tr><td>
						<%-- CONTENT --%><%
							request.setAttribute("genericRecommendationsVariant", tab.get(selectedTab));
						    request.setAttribute("parentImpressionId", tab.getParentImpressionId());
						    request.setAttribute("parentVariantId", tab.getTabVariant().getId());
						
							for ( int k=0; k < numTabs; k++ ) {
									boolean selected = selectedTab == k; 
									int savingsItemCount = 0;
									double savingsPercent = 0.0;
									double sumOfSavings = 0.0;
									String promotionCode = "";
									String hideSavingsUrl = "";
                                    Date promoExpDate = new Date();
									if (tab.get(k).isSmartSavings()) {
                                        
										FDUserI xUser = (FDUserI) session.getAttribute(SessionName.USER);
										Map xNodes = (Map) session.getAttribute(SessionName.SMART_STORE_PREV_RECOMMENDATIONS);
										savingsItemCount = SmartStoreUtil.countSavingProductsInCart(tab.get(k), xUser, xNodes);
										savingsPercent = xUser.getPromoVariant(tab.get(k).getId()).getPercentageOff();
										promotionCode = URLEncoder.encode(xUser.getPromoVariant(tab.get(k).getId()).getAssignedPromotion().getPromotionCode(), "UTF-8");
                                        promoExpDate = xUser.getPromoVariant(tab.get(k).getId()).getAssignedPromotion().getExpirationDate();
										sumOfSavings = SmartStoreUtil.sumOfSavingsInCart(tab.get(k), xUser, xNodes);
										hideSavingsUrl = gen.set("hideSavingsVarId", tab.get(k).getId()).build();
									}
									%> 
										<div id="header_<%= tab.get(k).getId() %>" class="tab_text_descr"<%= selected ? "" : " style=\"display: none;\"" %>>
									    <% if (!tab.get(k).isSmartSavings()) { %>						
											<%= tab.getTabDescription(k) %>
										<% } else {
											MessageFormat xFormat = new MessageFormat(tab.getTabDescription(k));
											Object[] xParams = { new Integer(savingsItemCount), new Double(savingsPercent), new Double(sumOfSavings), hideSavingsUrl, promotionCode, promoExpDate}; %>
											<%= xFormat.format(xParams) %><%
										   } %>							
										</div>
										<div id="content_<%= tab.get(k).getId() %>" style="width: 100%"<%= selected ? "" : " style=\"display: none;\"" %>>
											<% if (selected) { %><%@ include file="i_generic_recommendations.jspf" %><% } %>
										</div>
										<div id="footer_<%= tab.get(k).getId() %>" class="tab_text_desc" style="text-align: center;<%= selected ? "" : " display: none;\"" %>"><%
										if (tab.getTabFooter(k) != null) {
										%>
									    <% if (!tab.get(k).isSmartSavings()) { %>						
											<%= tab.getTabFooter(k) %>
										<% } else {
											MessageFormat xFormat = new MessageFormat(tab.getTabFooter(k));
											Object[] xParams = { new Integer(savingsItemCount), hideSavingsUrl, promotionCode }; %>
											<%= xFormat.format(xParams) %><%
										   } 
										} %>							
										</div><%
							}
						%>
					</td></tr></table></div></td>
				</tr>
			</table>
			
			<table width="<%= totalWidth %>px" height="8px" class="tab">
				<tr height="8px">
					<td width="8px" height="8px" class="tab">
						<img alt="" src="/media_stat/images/carttab_corners/carttab_cor_bl.gif" class="tab">
					</td>
					<td width="<%= totalWidth-16 %>px" height="8px" background="/media_stat/images/carttab_corners/carttab_bg_bottom.gif" class="tab">
					</td>
					<td width="8px" height="8px" class="tab">
						<img alt="" src="/media_stat/images/carttab_corners/carttab_cor_br.gif" class="tab">
					</td>
				</tr>
			</table>	


			<%-- =============== AJAX =============== --%>
			
			<script type="text/javascript">
			
				var loadingMessage = "<br/><br/><br/><br/><p class=\"tab_text_simple\">Refreshing, please wait...</p><br/><br/><br/><br/>";
				var errorMessage = "<br/><br/><br/><br/><p class=\"tab_text_simple\">Sorry, we weren't able to get recommendations.<br/><a href=\"/unsupported.jsp\" onClick=\"window.location.reload(false); return false;\">Click here</a> to refresh with new products. </p><br/><br/><br/><br/>";
				var loadingLink = "<span class=\"text13bold\" style=\"color: #875087; \">Refreshing...</span>";
				var smartStoreFacility = "<%= smartStoreFacility %>";

				var prezFormURI = '<%=response.encodeURL(request.getRequestURL().toString().replaceFirst("^[^:]*://[^/]*/", "/")) %>';

				var PIP = {
					tabs: [],
					features: [],
					selected: '<%= tab.get(selectedTab).getId() %>',
					parentImpressionId : '<%= tab.getParentImpressionId() + ':' + tab.getTabVariant().getId() %>',
					impressionIds: [],
				
				
					onFailure: function(tabId) {
						YAHOO.util.Dom.get('content_'+tabId).innerHTML = errorMessage;
					},
					
				
					onSuccess: function(resp, tabId) {
						YAHOO.plugin.Dispatcher.process('content_'+tabId, resp.responseText);
					},

					onTimeout: function() {
						window.location.reload(false);
					},
				
					load: function(tab, tabPos) {
						var ctnt = YAHOO.util.Dom.get('content_'+tab);
						if (ctnt.childNodes.length == 0 || (ctnt.childNodes.length == 1 && ctnt.firstChild.nodeType != 1)) {
							YAHOO.util.Dom.get('content_'+tab).innerHTML = loadingMessage;
							PIP.refresh(tab, tabPos, false);
						} else {
							PIP.norefresh(tab, tabPos);
						}
					},

					_call: function(tabId, uri) {
						var self = this;
						if ( YAHOO.util.Dom.get('ra_'+tabId) != null ) {
							YAHOO.util.Dom.get('ra_'+tabId).innerHTML = loadingLink;
						}
						YAHOO.util.Connect.asyncRequest('GET', uri, {
							success: function(resp) {
								if ( resp.status === 205 ) {
									self.onTimeout();
								} else {
									self.onSuccess(resp, tabId);
								}
							},
							failure: function(resp) {
								self.onFailure(tabId);
							}
						});
					},


					baseURI: function(pageURI, tabId, tabPos, isRefresh) {
						var uri = (pageURI || '/ajax/refresh.jsp')+
							'?tab='+tabPos+
							'&variant='+tabId+
							'&siteFeature='+PIP.features[tabId]+
							'&formUri='+prezFormURI+'&impId='+PIP.impressionIds[tabPos] +
							'&pImpId='+PIP.parentImpressionId+
							'&facility='+smartStoreFacility+
							(isRefresh?'&refresh=true':'');
						return uri;
					},
					
					refresh: function(tabId, tabPos, isRefresh) {
						var uri = this.baseURI(null, tabId, tabPos, isRefresh);
						this._call(tabId, uri);
					},

					backward: function(tabId, tabPos, isRefresh) {
						var uri = this.baseURI(null, tabId, tabPos, isRefresh)+'&page=prev';
						this._call(tabId, uri);
					},

					forward: function(tabId, tabPos, isRefresh) {
						var uri = this.baseURI(null, tabId, tabPos, isRefresh)+'&page=next';
						this._call(tabId, uri);
					},

					goToPage: function(tabId, tabPos, isRefresh, pnumber) {
						var uri = this.baseURI(null, tabId, tabPos, isRefresh)+'&page='+pnumber;
						this._call(tabId, uri);
					},

					norefresh: function(tabId, tabPos) {
						var uri = '/ajax/norefresh.jsp?tab='+tabPos+'&variant='+tabId+'&siteFeature='+PIP.features[tabId];
						YAHOO.util.Connect.asyncRequest('HEAD', uri, {});
					}
				};
		
				
				
				<%-- init tabs --%>
				<% for (int k=0; k<numTabs; k++) {
				%>PIP.tabs.push('<%= tab.get(k).getId() %>');
				PIP.features['<%= tab.get(k).getId() %>'] = '<%= tab.get(k).getSiteFeature().getName() %>';
				PIP.impressionIds.push('<%= tab.getFeatureImpressionId(k) %>');
				<% } %>
				
				<%-- attach to tabs --%>
				for (k=0; k<PIP.tabs.length; k++) {
					YAHOO.util.Event.on(YAHOO.util.Dom.get('td_'+PIP.tabs[k]), 'click', function(e) {
						YAHOO.util.Event.preventDefault(e);
		
						var sel = this.getAttribute('vid');
						
						for ( ii=0; ii<PIP.tabs.length; ii++ ) {
		
							if ( ii === 0 ) { // first tab
								YAHOO.util.Dom.get('img_'+PIP.tabs[ii]).src = '/media_stat/images/carttab_corners/carttab_first_left_'+(PIP.tabs[ii]===sel ? 'on' : 'off')+'.gif';
							} else {
								YAHOO.util.Dom.get('img_'+PIP.tabs[ii]).src = '/media_stat/images/carttab_corners/carttab_btwn_'+(PIP.tabs[ii-1]===sel ? 'on' : 'off')+'_'+(PIP.tabs[ii]===sel ? 'on' : 'off')+'.gif';
							}
		
							if ( ii === PIP.tabs.length-1 ) { // last tab
								YAHOO.util.Dom.get('img_last').src = '/media_stat/images/carttab_corners/carttab_btwn_'+(PIP.tabs[ii]===sel ? 'on' : 'off')+'_nothing.gif';
							}					
						}
						
						if (PIP.selected != this.getAttribute('vid')) {
		
							// previous selected tab					
							YAHOO.util.Dom.get('content_'+PIP.selected).style.display = 'none';
							YAHOO.util.Dom.get('header_'+PIP.selected).style.display = 'none';
							YAHOO.util.Dom.get('footer_'+PIP.selected).style.display = 'none';
							
							YAHOO.util.Dom.get('a_'+PIP.selected).className = 'tab_inactive';				
							YAHOO.util.Dom.get('td_'+PIP.selected).className = 'tab_title_inactive';					
							
							// newly selected tab 
							PIP.selected = this.getAttribute('vid');
							YAHOO.util.Dom.get('content_'+PIP.selected).style.display = '';
							YAHOO.util.Dom.get('header_'+PIP.selected).style.display = '';
							YAHOO.util.Dom.get('footer_'+PIP.selected).style.display = '';
							
							YAHOO.util.Dom.get('a_'+PIP.selected).className = 'tab_active';				
							YAHOO.util.Dom.get('td_'+PIP.selected).className = 'tab_title_active';
				
							// load content (if necessary)
							PIP.load(PIP.selected, this.getAttribute("tpos"));
						}
						
					});
				}
			</script>
			
		<% } %>	
</fd:PIPTab>
