<%@page import="com.freshdirect.fdstore.content.ContentNodeModel"%>
<%@page import="com.freshdirect.fdstore.DealsHelper"%>
<%@page import="com.freshdirect.fdstore.content.Html"%>
<%@page import="java.util.Iterator"%>
<%@page import="com.freshdirect.fdstore.content.Image"%>
<%@page import="com.freshdirect.fdstore.content.CategoryModel"%>
<%@page import="com.freshdirect.fdstore.content.DepartmentModel"%>
<%@page import="com.freshdirect.webapp.util.JspMethods"%>
<%@page import="com.freshdirect.fdstore.content.SkuModel"%>
<%@page import="java.util.Collections"%>
<%@page import="com.freshdirect.fdstore.content.ProductModel"%>
<%@page import="com.freshdirect.fdstore.content.ContentFactory"%>
<%@page import="java.util.Comparator"%>
<%@page import="java.util.ArrayList"%>
<%@page import="java.util.List"%>
<%@page import="com.freshdirect.fdstore.content.ProductContainer"%>
<%@page import="com.freshdirect.webapp.taglib.fdstore.SessionName"%>
<%@page import="com.freshdirect.webapp.taglib.fdstore.FDSessionUser"%>
<%@page import='com.freshdirect.fdstore.pricing.ProductPricingFactory' %>
<%@page import ='com.freshdirect.fdstore.customer.*'%>

<%@ taglib uri='freshdirect' prefix='fd' %>
<%@ taglib uri="/WEB-INF/shared/tld/fd-display.tld" prefix='display' %>

<%-- Featured Products column --%>

<%
	int FAVS_PER_LINE		= DealsHelper.getMaxFeaturedDealsPerLine(); 				//number of products to show per line
	int MAX_FAVSLINES2SHOW	= DealsHelper.getMaxFeaturedDealsForPage()/FAVS_PER_LINE; 	//number of lines of featured products
	int MIN_FAVS2SHOW		= DealsHelper.getMinFeaturedDealsForPage(); 				//minimum featured products required to show featured section
	int	MAX_FAVS2SHOW		= FAVS_PER_LINE * MAX_FAVSLINES2SHOW; 						//to keep each row matching
%>

<display:FeaturedProductsHelper currentFolder="<%=(DepartmentModel)currentFolder%>" maxFavsToShow="<%=MAX_FAVS2SHOW%>"/>

<% if (favoritesToShow >= MIN_FAVS2SHOW) { %>
	<!-- separator  -->
	<tr>
		<td colspan="6">
			<br /><img src="/media_stat/images/layout/cccccc.gif" width="550" height="1" border="0"><br />
			<font class="space4pix"><br /><br /></font>
		</td>
	</tr>

	<tr>
		<td colspan="6">
	        <%
			// display department specific media
			if (isDepartment) {
				DepartmentModel department = (DepartmentModel) currentFolder;
				if (department.getDepartmentMiddleMedia() != null) {
					for(Iterator<Html> deptBotItr = department.getDepartmentMiddleMedia().iterator(); deptBotItr.hasNext();) {
						Html piece = deptBotItr.next();
						if (piece != null) {
				        	String deptBotItm = piece.getPath();
                            %><fd:IncludeMedia name='<%= deptBotItm %>' /><%
				    	}
					}
				}
                                   
			}
	        %>
	        <font class="space4pix"><br/><br/></font>
        
			<table border="0" cellspacing="0" cellpadding="0" align="center">
           		<tr>
	            	<%  
	            	List<String> row = favHTMLPieces;
	            	for ( int k = 0; k < row.size(); ++k ) { %>
	            		<td align="center" valign="<%= row == favHTMLPieces ? "bottom" : "top" %>" width="110">
	            			<%= row.get(k) %>
	            		</td>
	            		
	            		<%
            			// start a new row if it has enough content
            			if (k>0 && (k%FAVS_PER_LINE) == FAVS_PER_LINE-1) { %>
							</tr>
							
							<% if (row == favHTMLPieceLinks) { //close out table, start new %>
								</table><table border="0" cellspacing="0" cellpadding="0" align="center">
							<% } else { %>						
								<tr>
							<% }	
						
							row = row == favHTMLPieces ? favHTMLPieceLinks : favHTMLPieces;
							if (row == favHTMLPieceLinks) 
								k -= FAVS_PER_LINE;
								
	            		} else if (k == row.size() -1) {
	            			
							if (row == favHTMLPieces) { 
            					%></tr><tr><%
            					row = favHTMLPieceLinks;
            					k -= (favHTMLPieces.size()%FAVS_PER_LINE);
							}	
	            		}
	            	}
	            	%>
            	</tr>
			</table>
					
			<%-- close the featured product column --%>
		
			<%    
        	if (isDepartment) {
            	DepartmentModel department = (DepartmentModel) currentFolder;
            	if( department.getDepartmentBottom() != null ) {
                	for(Iterator deptBotItr = department.getDepartmentBottom().iterator(); deptBotItr.hasNext();) {
			        	Html piece = (Html)deptBotItr.next();
			        	if (piece != null) {
			            	String deptBotItm = piece.getPath();
    						%><br/><fd:IncludeMedia name='<%= deptBotItm %>' /><%
                    	}
                	}
            	}
        	} %> 
    
		</td>
	</tr>
<% } %>
		