<%@page import="com.freshdirect.webapp.util.JspMethods"%>
<%@page import="java.text.SimpleDateFormat"%>
<%@page import="com.freshdirect.framework.util.QuickDateFormat"%>
<%@page import="com.freshdirect.ErpServicesProperties"%>
<%@page import="com.freshdirect.framework.util.DateUtil"%>
<%@page import="java.util.GregorianCalendar"%>
<%@page import="java.util.Calendar"%>
<%@page import="java.util.Date"%>
<%@page import="com.freshdirect.fdstore.content.DomainValue"%>
<%@page import="java.util.Iterator"%>
<%@page import="java.util.List"%>
<%@page import="com.freshdirect.webapp.util.JspLogger"%>
<%@page import="com.freshdirect.fdstore.FDSkuNotFoundException"%>
<%@page import="com.freshdirect.fdstore.FDCachedFactory"%>
<%@page import="com.freshdirect.fdstore.FDSalesUnit"%>
<%@page import="com.freshdirect.fdstore.FDProduct"%>
<%@page import="com.freshdirect.webapp.taglib.fdstore.layout.DealsPageHelper"%>
<%@page import="java.text.NumberFormat" %>

<%@ taglib uri='freshdirect' prefix='fd' %>

<fd:FDProductInfo id="productInfo" skuCode="<%=sku.getSkuCode()%>">

	<%
	{
		FDProduct product = null;
		String salesUnitDescription = "NA";
		String salesUnitName = "NA";
		FDSalesUnit[] salesUnits;
		boolean skuAvailable = !sku.isUnavailable();
	
		if (skuAvailable) {
			try {
				product = FDCachedFactory.getProduct(productInfo);
				salesUnits = product.getSalesUnits();
				if (salesUnits.length>0) {
					salesUnitDescription = salesUnits[0].getDescription();
					salesUnitName = salesUnits[0].getName();
				}
			} catch (FDSkuNotFoundException fdsnf){
				JspLogger.PRODUCT.warn("Grocery Page: catching FDSkuNotFoundException and Continuing:\n FDProductInfo:="+productInfo+"\nException message:= "+fdsnf.getMessage());
				throw new JspException("FDProduct not found for available product",fdsnf);
			}
		}
		String qtyFldName = "quantity_"+itemShownIndex;
		%>

		<tr <%=skuAvailable && i % 2 ==0 && "false".equalsIgnoreCase(request.getParameter("showThumbnails"))?"bgcolor='#EEEEEE'":""%>>
			<td width="40" align="center">
				<nobr>
			
					<%  if (!skuAvailable) {  %>
					    <font color="#999999">NA</font>
					<%  } %>
					<input type="<%= skuAvailable ? "text" : "hidden" %>
					    name="<%= qtyFldName %>" size="2" maxlength="2" class="text11" value="<%= !skuAvailable ? "" : request.getParameter(qtyFldName) %>"
					    onChange="javascript:chgQty('<%= qtyFldName %>', 0, <%= displayProduct.getQuantityMinimum() %>, <%= user.getQuantityMaximum(displayProduct) %>); syncQty('<%= itemShownIndex %>', 'big');">
				</nobr>
			</td>
			
			
			<td width="10">
				<%  if (!skuAvailable) {  %>&nbsp;<%  } else {    %>
					<a href="javascript:chgQty('<%= qtyFldName %>', <%= displayProduct.getQuantityIncrement() %>, <%= displayProduct.getQuantityMinimum() %>, <%= user.getQuantityMaximum(displayProduct) %>); syncQty('<%= itemShownIndex %>', 'big');">
					<img src="/media_stat/images/layout/grn_arrow_up.gif" width="10" height="9" border="0" vspace="2" alt="Increase quantity"></a><br/>
					<a href="javascript:chgQty('<%= qtyFldName %>', -<%= displayProduct.getQuantityIncrement() %>, <%= displayProduct.getQuantityMinimum() %>, <%= user.getQuantityMaximum(displayProduct) %>); syncQty('<%= itemShownIndex %>', 'big');">
					<img src="/media_stat/images/layout/grn_arrow_down.gif" width="10" height="9" border="0" vspace="2" alt="Decrease quantity"></a>
				<%  }   %>
			</td>
	
			<td width="10" align="center" valign="middle">
				<img SRC="/media_stat/images/layout/clear.gif" name="bullet<%= itemShownIndex %>" width="6" height="6" border="0" alt="">
			</td>
	
			<td width="300">
				<%
				    String unAvailableFontStart = "";
				    String unAvailableFontEnd = "";
					//add correct unavailable color for links
					String unAvailableStyle = "";
				    if (!skuAvailable) {  
				        unAvailableFontStart = "<font color=\"#999999\">";
				        unAvailableFontEnd = "</font>";
						//set style color
						unAvailableStyle = " style=\"color:#999;\"";
				    }
				
				    String thisProdBrandLabel = displayProduct.getPrimaryBrandName();
					List<DomainValue> domains = sku.getVariationMatrix();
					StringBuffer key = new StringBuffer();
					for(Iterator<DomainValue> mi = domains.iterator(); mi.hasNext(); ){
						DomainValue domainValue = mi.next();
						key.append(domainValue.getLabel());
						key.append("  ");
						key.deleteCharAt(key.length()-1);
					}
					String prodMatrix= (key.length()>0 ? ", " + key.toString() : "");
				
				    String productURL = response.encodeURL("/deals.jsp?catId=" + currentFolder
						+ DealsPageHelper.buildOtherParams(showThumbnails, itemsToDisplay, -1, brandValue, sortBy, nutriName, request, null)
						+ "&sortDescending=" + descending
						+ "&disp=" + display
						+ "&prodCatId=" + displayProduct.getParentNode()
						+ "&productId=" + displayProduct +"&skuCode="+sku.getSkuCode()+"&trk=trans");
				%>
				<%= unAvailableFontStart %>
				<a href="javascript:selectProduct('<%= productURL %>', '<%= qtyFldName %>')"<%=unAvailableStyle%>>
					<font class="text10bold"><%= unAvailableFontStart %><%= thisProdBrandLabel %><%= unAvailableFontEnd %></font>
					<font class="text10"><%= unAvailableFontStart %><%= displayProduct.getFullName().substring(thisProdBrandLabel.length()).trim()+prodMatrix %><%= unAvailableFontEnd %></font>
				</a>
				<%= unAvailableFontStart %> 
				<nobr>
					<%= !"nm".equalsIgnoreCase(salesUnitDescription) ? "- " + salesUnitDescription  : "" %><%= unAvailableFontEnd %><%="nutrition".equalsIgnoreCase(sortBy)?"&nbsp;<b>" + JspMethods.formatDefaultPrice(productInfo, user.getPricingContext()) + "</b>":"" %>
				</nobr><br/>
				
				<%
				    Date earliestDate = sku.getEarliestAvailability();
				    Calendar testDate = new GregorianCalendar();
				    testDate.add(Calendar.DATE, 1);
				    // cheat: if no availability indication, show the horizon as the earliest availability
				    if (earliestDate == null) {
				        earliestDate = DateUtil.addDays( DateUtil.truncate( new Date() ), ErpServicesProperties.getHorizonDays() );
				    }
				    if(skuAvailable && QuickDateFormat.SHORT_DATE_FORMATTER.format(testDate.getTime()).compareTo(QuickDateFormat.SHORT_DATE_FORMATTER.format(earliestDate)) < 0){
				        SimpleDateFormat sf = new SimpleDateFormat("MM/dd");
				        %><b><font color="#999999">Earliest Delivery - <%= sf.format(earliestDate) %></font></b><%
				    }
				%>
				
				<%  if (skuAvailable) { %>&nbsp;&nbsp;<span class="text10"><%@include file="/includes/product/i_scaled_prices_nobr.jspf"%></span><% } %>
			</td>
	
	       
		    <% if ( !skuAvailable ) {  %>
		    	<td colspan="2" width="85" align="center">
		    		<font color="#999999"><%=(productInfo.isOutOfSeason()?"Out&nbsp;of&nbsp;Season": "Not&nbsp;Available")%></font>
		    	</td>
		    <% } else if ( productInfo.getZonePriceInfo(user.getPricingContext().getZoneId()).isItemOnSale()) { %>
			    <td width="200" align="left">
			    	&nbsp;<font class="groceryProductLinePrice" style="color: #c00"><%= JspMethods.formatDefaultPrice(productInfo, user.getPricingContext()) %>&nbsp;</font>
			    	<font style="font-size: 7pt; color: #888"><%= "(was "+JspMethods.formatSellingPrice(productInfo, user.getPricingContext())+")" %>&nbsp;</font>
			    </td>
			<% } else { %>
		    	<td width="55" align="right">
		    		&nbsp;<font class="groceryProductLinePrice"><%= JspMethods.formatDefaultPrice(productInfo, user.getPricingContext()) %>&nbsp;</font>
		    	</td>
		    <% } %>
		    
			<fd:CCLCheck>
				<td align="center">
					<% if (skuAvailable) { 
						String sideBarIndex = "ccl_sidebar_" + itemShownIndex; %>
						<a href="/unsupported.jsp" onclick="return CCL.save_items('grocery_form',this,'action=CCL:AddMultipleToList&source=<%=sideBarIndex%>')">
							<img src="/media_stat/images/buttons/icon_list_save.gif" alt="Add this item to a list" border="0">
						</a>
					<% } %>
				</td>
			</fd:CCLCheck>
			
			<td align="center">
				<input type="hidden" name="salesUnit_<%= itemShownIndex %>" value="<%= salesUnitName %>">
				<input type="hidden" name="skuCode_<%= itemShownIndex %>" value="<%= sku.getSkuCode() %>">
				<input type="hidden" name="catId_<%= itemShownIndex %>" value="<%= displayProduct.getParentNode() %>">
				<input type="hidden" name="productId_<%= itemShownIndex %>" value="<%= displayProduct %>">
				<% if ( skuAvailable ) { %>
		    		<input type="image" name="addSingleToCart_<%= itemShownIndex %>" src="/media_stat/images/buttons/grocery_addtocart.gif" border="0" alt="Add this item to your cart">
				<% } %>
			</td>
		</tr>
	<% } %>
</fd:FDProductInfo>
