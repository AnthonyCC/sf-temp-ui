<%@page import="com.freshdirect.framework.util.StringUtil"%>
<%@ page import='com.freshdirect.fdstore.FDStoreProperties' %>
<%@ page import='java.text.*' %>
<%@ page import="java.util.*" %>
<%@ taglib uri='freshdirect' prefix='fd' %>
<%@ taglib uri='logic' prefix='logic' %>
<%
	String[] checkContactForm_i_contact_us = {"subject", "message", "email", "first_name", "last_name", "home_phone"};
	String faqSections_i_contact_us = FDStoreProperties.getFaqSections();
	String csNumberMedia_i_contact_us = user.getCustomerServiceContactMediaPath();
%>
<fd:ContactFdController result="result" successPage='/help/contact_fd_thank_you.jsp'>
	<fd:ErrorHandler result='<%=result%>' name='kana' id='errorMsg'>
		<%@ include file="/includes/i_error_messages.jspf" %>
	</fd:ErrorHandler>

	<fd:ErrorHandler result='<%=result%>' field='<%=checkContactForm_i_contact_us%>'>
		<% String errorMsg = SystemMessageList.MSG_MISSING_INFO; %>
		<%@ include file="/includes/i_error_messages.jspf" %>	
	</fd:ErrorHandler>

	<fd:ErrorHandler result='<%=result%>' name='technical_difficulty' id='errorMsg'>
		<%@ include file="/includes/i_error_messages.jspf" %>	
	</fd:ErrorHandler>
	
	
	<form fdform method="post" name="contact_fd" id="contact_fd_contact" fdform-displayerrorafter>
		<a href='index.jsp'><h2 class="help-heading bold uppercase">contact freshdirect</h2></a>
		<p class="small-text">FreshDirect Customer Service is standing by to answer your questions, seven days a week.
			<span class="bold">The best way to get help is through email. Our dedicated service team generally responds within 1 to 3 hours during our business day.</span>
		</p>
		
		<div class="underline">
			<h3 class="bold inline">1. Enter Your Message</h3>
			<span class="small"> * Required information</span>	
		</div>

		<script type="text/javascript">
				var coremetricsGetHelpEmailFunctionMap = [
				<logic:iterate id="subject" indexId="idx" collection="<%= ContactFdControllerTag.selections %>" type="com.freshdirect.webapp.taglib.fdstore.ContactFdControllerTag.Selection">
					<%if (idx!=0){%>,<%}%><fd:CmConversionEvent wrapIntoFunction="true" eventId="email" firstPhase="true" subject="<%=StringUtil.escapeJavaScript(subject.getDescription())%>"/>
				</logic:iterate>
			];
			<%--
				This seems sort of useless, it only logs a single subject change?
				Changed to work the same with new js (called once on page load (no log),
				then on every subject change (log only the first change))
				still... seems... weird.
				-BA 20140401
			--%>
			var coremetricsGetHelpEmailStartLogged = 0; //init
			function coremetricsGetHelpEmailStart(index) {
				if (coremetricsGetHelpEmailStartLogged == 1) {
					coremetricsGetHelpEmailFunctionMap[index]();
				}
				coremetricsGetHelpEmailStartLogged++;
			}
			
			$jq('#prodReqContent').ready(function() { $jq('#prodReqContent').hide(); });
			$jq(document).ready(function() {
				$jq('#contact_subject').change(function() {
					var selectedOpt = $jq('#contact_subject option').filter(':selected');
					if ( selectedOpt.text() == 'Product Request' ) {
                        $jq('#prodReqContent').show();
                        $jq('#prodReqNonContent').hide();
                        $jq('#test1').attr('disabled', 'disabled').addClass('disabled');
                    } else {
                        $jq('#prodReqContent').hide();
                        $jq('#prodReqNonContent').show();
                        $jq('#test1').attr('disabled', null).removeClass('disabled');
                    }
					if (coremetricsGetHelpEmailFunctionMap[selectedOpt.val()]) {
						coremetricsGetHelpEmailStart(selectedOpt.val());
					}
				});
				$jq('#contact_subject').change();
			});

		</script>
		<div class="from-elements-wrapper">
			<div class="form-group">
				<label for="contact_subject" class="bold inline text-right">* Subject:</label>
				<select class="customsimpleselect" aria-describedby="subject_error" name="subject" id="contact_subject" onchange="">
					<option value="">Select Subject:</option>
					<logic:iterate id="subject" indexId="idx" collection="<%= ContactFdControllerTag.selections %>" type="com.freshdirect.webapp.taglib.fdstore.ContactFdControllerTag.Selection">
						<option value="<%= idx %>" <%= idx.intValue() == subjectIndex ? "selected" : "" %>><%= subject.getDescription() %></option>
					</logic:iterate>
				</select>
				<fd:ErrorHandler result='<%=result%>' name='subject' id='errorMsg'>
					<%--if error occured with subject selection, tracking is needed, because subject will be changed automatically--%>
					<script type="text/javascript">
						var subjectSelect = document.getElementById('contact_subject');	
						coremetricsGetHelpEmailStart(subjectSelect.options[subjectSelect.selectedIndex].value)
					</script>
					<div id="subject_error" class="bold error">
						<%=errorMsg%>
					</div>
				</fd:ErrorHandler>

			<%
				/* APPDEV-1744	Product Request - 2011 CS Project */
				Map params = new HashMap();
				params.put("baseUrl", "");
				boolean isDefaultFtl = true;
				String faqPage = "req_feedback"; //set as product request
				
				/* only add this if we have faq sections (since we need them to determine this) */
				if (null != faqSections_i_contact_us) {
					params.put("faqNodes", FDFaqUtil.getFaqsByCategory(faqPage));

					StringTokenizer st = new StringTokenizer(faqSections_i_contact_us, ",");
					while (st.hasMoreTokens()) {
						String nextToken = st.nextToken().trim();
						params.put(nextToken, FDFaqUtil.getFaqsByCategory(nextToken));
						if (nextToken.equalsIgnoreCase(faqPage) && isDefaultFtl) {
							isDefaultFtl = false;
						}
					}

					/* add additional param special for this, so we can change the look of the included ftl */
					params.put("faqContact", "true");
			%>
				<div id="prodReqContent" style="display: none;">
						<fd:IncludeMedia name="/media/editorial/faq/req_feedback.ftl" parameters="<%=params%>" withErrorReport="false"/>
				</div>
			<% } %>
			</div>
			
			<div id="prodReqNonContent">
				<div class="form-group">
					<% if (identity != null) { %>
						<fd:OrderHistoryInfo id='orderHistoryInfo'>
							<%if (orderHistoryInfo.size() > 0) {%>
									<label for="order-field" class="bold inline text-right">Order #:</label>
									<select class="customsimpleselect" name="salePK" id="order-field">
										<option value="">Select Order:</option>
										<logic:iterate id="orderInfo" indexId="idx" collection="<%= orderHistoryInfo %>" type="com.freshdirect.fdstore.customer.FDOrderInfoI">
											<% if (idx.intValue() == 5) break; %>
											<option value="<%= orderInfo.getErpSalesId() %>">#<%= orderInfo.getErpSalesId() %> - <%=orderInfo.getOrderStatus().getDisplayName()%> - <%= dateFormatter.format( orderInfo.getRequestedDate() ) %></option>
										</logic:iterate>
									</select>
									<span class="optionalaccess">(optional)</span>
							<% } %>
						</fd:OrderHistoryInfo>
					<% } %>
				</div>
				<div class="form-group">
					<label for="msg-textarea" id="msg-textarea-label" class="bold inline">* Please enter your message here:</label>
					<textarea id="msg-textarea" cols="40" aria-describedby="message_error" rows="5" name="message" onKeyPress="limitText(this, 2048)" onChange="limitText(this, 2048)"><%= body%></textarea>
					<fd:ErrorHandler result='<%=result%>' name='message' id='errorMsg'>
						<div id="message_error" class="bold error">
							<%=errorMsg%>
						</div>
					</fd:ErrorHandler>
				</div>
				</div>
			</div>
			<%-- info --%>
			<%if (identity == null) { %>
			<div class="underline">
				<h4 class="bold inline">2. Enter Your Contact Information</h4>
				<span class="small"> * Required information</span>
			</div>
			<div class="from-elements-wrapper">
			<div class="form-group">	
				<label for="email-field" class="bold inline">* E-mail Address/    User Name:</label>
				<input type="text" name="email" id="email-field" aria-describedby="emailid_error" size="34" value="<%=email%>" />
				<fd:ErrorHandler result='<%=result%>' name='email' id='errorMsg'><span id="emailid_error" class="bold error"><%=errorMsg%></span></fd:ErrorHandler>
			</div>
			<div class="form-group">
				<label for="first-name-field" class="bold inline">* First Name:</label>
				<input type="text" name="first_name" id="first-name-field" aria-describedby="firstname_error" size="21" value="<%=firstName%>" />
				<fd:ErrorHandler result='<%=result%>' name='first_name' id='errorMsg'><span id="firstname_error" class="bold error"><%=errorMsg%></span></fd:ErrorHandler>
			</div>
			<div class="form-group">
				<label for="last-name-field" class="bold inline">* Last Name:</label>
				<input type="text" name="last_name" id="last-name-field" aria-describedby="lastname_error" size="21" value="<%=lastName%>" />
				<fd:ErrorHandler result='<%=result%>' name='last_name' id='errorMsg'><span id="lastname_error" class="bold error"><%=errorMsg%></span></fd:ErrorHandler>
			</div>
			<div class="form-group">
				<label for="home-phone-field" class="bold inline">Home Phone #:</label>
				<input type="text" name="home_phone" id="home-phone-field" size="21" value="<%=homePhone%>" maxlength="15" />
				<label for="home-phone-ext-field">Ext.<span class="offscreen">extension for home phone number</span></label>
				<input type="text" name="home_phone_ext" id="home-phone-ext-field" size="4" value="<%=homePhoneExt%>" maxlength="6" />
			</div>
			<div class="form-group">
				<label for="work-phone-field" class="bold inline">Work Phone #:</label>
				<input type="text" name="work_phone" id="work-phone-field" size="21" value="<%=workPhone%>" maxlength="15" />
				<label for="work-phone-ext-field">Ext.<span class="offscreen">extension for work phone number</span></label>
				<input type="text" id="work-phone-ext-field" name="work-phone-ext-field" size="4" value="<%=workPhoneExt%>" maxlength="6" />
			</div>
			<div class="form-group">
				<label for="other-phone-field" class="bold inline">Other Phone #:</label>
				<input type="text" name="alt_phone" id="other-phone-field" size="21" value="<%=altPhone%>" maxlength="15" />
				<label for="other-phone-ext-field">Ext.<span class="offscreen">extension for other phone number</span></label>
				<input type="text" name="alt_phone_ext" id="other-phone-ext-field"  size="4" value="<%=altPhoneExt%>" maxlength="6" />
			</div>
		</div>
			<% }else{ %>
				<div class="underline">
					<h4 class="bold inline">2. Enter Your Contact Information</h4>
				</div>
				<div class="form-group text-center small-text">
					<span class="bold">E-mail Address/User Name:</span><span> <%=email%></span>
				</div>
				<div class="form-group text-center small-text">
					<span class="bold">Name:</span><span> <%=firstName%> <%=lastName%></span>
				</div>
				<div class="form-group text-center small-text">
					<a href='/your_account/signin_information.jsp'>(If this information is incorrect, click here!)</a>
				</div>
			<% } %>

			<div class="text-center separator">
				<button type="reset" class="cssbutton green transparent">Clear</button>
				<button type="submit" id="test1" name="sendMessage" class="cssbutton green ">Send Message</button>
			</div>
		<div class="small-text separator">
			<%--MEDIA INCLUDE--%><fd:IncludeMedia name="/media/editorial/site_pages/help_home_hours.html" /><%--END MEDIA INCLUDE --%>
			You may also call <%= (user.isChefsTable()) ? "toll-free" : "us" %> at <fd:IncludeMedia name="<%= csNumberMedia_i_contact_us %>" />
		</div>
	</form>
</fd:ContactFdController>