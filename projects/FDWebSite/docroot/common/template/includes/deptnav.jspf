<%@page import="com.freshdirect.webapp.util.FDFaqUtil"%>
<%@ page import="com.freshdirect.fdstore.referral.FDReferralManager"%>
<%@ page import="com.freshdirect.fdstore.referral.ReferralPromotionModel"%>
<%@page import="com.freshdirect.fdstore.content.CategoryModel"%>
<%@page import="com.freshdirect.fdstore.content.Image"%>
<%@page import="com.freshdirect.fdstore.FDStoreProperties"%>
<%@page import="com.freshdirect.fdstore.customer.FDIdentity"%>
<%@page import="java.util.LinkedHashMap"%>
<%@page import="com.freshdirect.webapp.util.FDURLUtil"%>
<%@page import="java.util.Map"%>
<%@page import="java.util.Iterator"%>
<%@ taglib uri='freshdirect' prefix='fd' %>
<%@ taglib uri='oscache' prefix='oscache' %>
<%
//doing a check for your account pages, making static department nav, otherwise, build one for departments below

if (request.getRequestURI().toLowerCase().indexOf("your_account/") != -1) {
%>
	<table cellpadding="0" cellspacing="0" border="0">
		<tr valign="middle">
			<%
				Map<String, String> folderMap=new LinkedHashMap<String, String>();
				folderMap.put("Your Orders","/your_account/order_history.jsp");
				if (user.isEligibleForStandingOrders()){
					folderMap.put("Your Standing Orders","/quickshop/standing_orders.jsp");
				}
				if(user.isEligibleForPreReservation()){
					folderMap.put("Reserve Delivery","/your_account/reserve_timeslot.jsp");
					folderMap.put("Delivery Addresses","/your_account/delivery_information.jsp");folderMap.put("Payment Options","/your_account/payment_information.jsp");folderMap.put("Your Account Preferences","/your_account/signin_information.jsp");
					/* APPDEV-2971 */ 
					/* if (!FDStoreProperties.isEmailOptdownEnabled()){folderMap.put("President's Picks Newsletter","/your_account/newsletter.jsp");} */
					folderMap.put("Reminder Service","/your_account/reminder_service.jsp");folderMap.put("Your Profile","/your_account/customer_profile_summary.jsp");
				}
				if(user.isEligibleForPreReservation() && (user.isDlvPassActive() || user.isEligibleForDeliveryPass())){
					 folderMap.put("Reserve Delivery","/your_account/reserve_timeslot.jsp");folderMap.put("FreshDirect DeliveryPass","/your_account/delivery_pass.jsp");folderMap.put("Delivery Addresses","/your_account/delivery_information.jsp");folderMap.put("Payment Options","/your_account/payment_information.jsp");folderMap.put("Your Account Preferences","/your_account/signin_information.jsp");
					 /* if (!FDStoreProperties.isEmailOptdownEnabled()){folderMap.put("President's Picks Newsletter","/your_account/newsletter.jsp");} */
				} if(user.isEligibleForPreReservation() && user.isGiftCardsEnabled() ){
					folderMap.put("Reserve Delivery","/your_account/reserve_timeslot.jsp");folderMap.put("Delivery Addresses","/your_account/delivery_information.jsp");folderMap.put("Payment Options","/your_account/payment_information.jsp");folderMap.put("Your Account Preferences","/your_account/signin_information.jsp");
					 /* if (!FDStoreProperties.isEmailOptdownEnabled()){folderMap.put("President's Picks Newsletter","/your_account/newsletter.jsp");} */
					 folderMap.put("Gift Cards","/your_account/giftcards.jsp");
				}if(user.isEligibleForPreReservation() && user.isGiftCardsEnabled() && (user.isDlvPassActive() || user.isEligibleForDeliveryPass())){
					folderMap.put("Reserve Delivery","/your_account/reserve_timeslot.jsp");folderMap.put("FreshDirect DeliveryPass","/your_account/delivery_pass.jsp");folderMap.put("Delivery Addresses","/your_account/delivery_information.jsp");folderMap.put("Payment Options","/your_account/payment_information.jsp");folderMap.put("Your Account Preferences","/your_account/signin_information.jsp");
					 /* if (!FDStoreProperties.isEmailOptdownEnabled()){folderMap.put("President's Picks Newsletter","/your_account/newsletter.jsp");} */
					 folderMap.put("Gift Cards","/your_account/giftcards.jsp");
				} if(!user.isEligibleForPreReservation() && user.isGiftCardsEnabled() && (user.isDlvPassActive() || user.isEligibleForDeliveryPass())){
					folderMap.put("FreshDirect DeliveryPass","/your_account/delivery_pass.jsp");folderMap.put("Delivery Addresses","/your_account/delivery_information.jsp");folderMap.put("Payment Options","/your_account/payment_information.jsp");folderMap.put("Your Account Preferences","/your_account/signin_information.jsp");
					 /* if (!FDStoreProperties.isEmailOptdownEnabled()){folderMap.put("President's Picks Newsletter","/your_account/newsletter.jsp");} */
					 folderMap.put("Gift Cards","/your_account/giftcards.jsp");
				} if(!user.isEligibleForPreReservation() && (user.isDlvPassActive() || user.isEligibleForDeliveryPass())){
					folderMap.put("FreshDirect DeliveryPass","/your_account/delivery_pass.jsp");folderMap.put("Delivery Addresses","/your_account/delivery_information.jsp");folderMap.put("Payment Options","/your_account/payment_information.jsp");folderMap.put("Your Account Preferences","/your_account/signin_information.jsp");
					 /* if (!FDStoreProperties.isEmailOptdownEnabled()){folderMap.put("President's Picks Newsletter","/your_account/newsletter.jsp");} */
				}
				folderMap.put("Reminder Service","/your_account/reminder_service.jsp");
				folderMap.put("Your Shopping Lists","/quickshop/all_lists.jsp");
				folderMap.put("Your Profile","/your_account/customer_profile_summary.jsp");
				
				if(user.isReferralProgramAvailable()) {
					FDIdentity customerIdentity = null;
					if (user!=null && user.getLevel() == 2){
						customerIdentity = user.getIdentity();
					}
					ReferralPromotionModel rpModel = FDReferralManager.getReferralPromotionDetails(customerIdentity.getErpCustomerPK());
					if(rpModel != null) {
						folderMap.put("Refer A Friend","/your_account/brownie_points.jsp");
					}
				}
				folderMap.put("Account Credits","/your_account/credits.jsp");
				
				int maxRows = 3;
				int maxCols = folderMap.size() / maxRows+(folderMap.size()%maxRows!=0?1:0);
				Iterator<String> itr=folderMap.keySet().iterator();
			%>
			<td>
				<a href="<%=response.encodeURL("/your_account/manage_account.jsp")%>">
		    		<img src="/media_stat/images/template/youraccount/youraccount_deptnav.gif" width="198" height="33" border="0" alt="YOUR ACCOUNT"></a>
			</td>
			<td>
				<table cellpadding="0" cellspacing="0" border="0">
						<% for ( int rowIndex = 0; rowIndex < maxRows; rowIndex++ ) { %>
						<tr>
							<%
							for ( int colIndex = 0; colIndex < maxCols && ((maxRows * colIndex) + rowIndex) < folderMap.size(); colIndex++ ) {%>
									<td class="onePxTall"><img src="/media_stat/images/layout/clear.gif" width="5" height="1" alt="" border="0"></td>
									<td width="1" bgcolor="#999966"><img src="/media_stat/images/layout/clear.gif" width="1" height="12" border="0"></td>
									<td class="onePxTall"><img src="/media_stat/images/layout/clear.gif" width="5" height="1" alt="" border="0"></td>
								        <%
										if(itr.hasNext()){
										String str=itr.next();
									%>
										<td><a href="<%= folderMap.get(str)%>"><%= str %></a><br/></td>
									<%}%>
							<%}%>

						</tr>
						<% } %>
				</table>
			</td>
			<td><img src="/media_stat/images/layout/clear.gif" width="1" height="<%= 13 * maxRows %>" border="0">&nbsp;
			</td>
		</tr>
		<tr><td><img src="/media_stat/images/layout/clear.gif" width="1" height="2" alt="" border="0"></td></tr>
	</table>
<% } else if (request.getRequestURI().toLowerCase().indexOf("help/") != -1) { %>
	<!-- help nav hard coded here -->
	<table cellpadding="0" cellspacing="0" border="0">
	    <tr>
		    <td valign="middle"><a href="/help/index.jsp"><img src="/media_stat/images/template/help/help_deptnav.gif"  border="0" alt="HELP"></a></td>
			<td><img src="/media_stat/images/layout/999966.gif" width="1" height="22" border="0" hspace="0" vspace="0" ALIGN="TOP">&nbsp;</td>
			<td class="text9_lh12">
			  <a href="/help/index.jsp">Contact Us</a><br />
				<a href="/help/faq_home.jsp?page=<%= FDFaqUtil.getFaqHomeId() %>">Frequently Asked Questions</a>
			</td>
			<td>&nbsp;<img src="/media_stat/images/layout/999966.gif" width="1" height="22" border="0" hspace="0" vspace="0" ALIGN="TOP">&nbsp;</td>
			<td class="text9_lh12">
			    <a href="/help/privacy_policy.jsp">Privacy Policy</a><br />
				<a href="/help/terms_of_service.jsp">Customer Agreement</a>
			</td>
		</tr>
		<tr>
			<td colspan="5"><img src="/media_stat/images/layout/clear.gif" width="1" height="4" border="0"></td>
		</tr>
	</table>
	
<% } else {  %>
	<%
		String deptId_deptNav = request.getParameter("deptId");
		String catId_deptNav = request.getParameter("catId");

		//fallback and check attributes on param fail
		if (deptId_deptNav == null || "".equals(deptId_deptNav)) {
			deptId_deptNav = (request.getAttribute("deptId")!=null)?request.getAttribute("deptId").toString():"";
			if ("".equals(deptId_deptNav.toString())) { deptId_deptNav = null; }
		}
		if (catId_deptNav == null || "".equals(catId_deptNav)) {
			catId_deptNav = (request.getAttribute("catId")!=null)?request.getAttribute("catId").toString():"";
			if ("".equals(catId_deptNav.toString())) { catId_deptNav = null; }
		}

	%>
	<oscache:cache key='<%= "deptNav_"+request.getQueryString() %>' time='600'>
		<% try { %>
			<fd:DeptNav id='department' categoryList='folderList' categoryId='<%= catId_deptNav %>' deptId='<%= deptId_deptNav %>'>
				<table cellpadding="0" cellspacing="0" border="0">
					<tr valign="middle">
						<%
							Image titleImg = department.getTitleImage();
							int maxRows = department.getMaxRowCount();
							int maxCols = folderList.size() / maxRows+(folderList.size()%maxRows!=0?1:0);
							//fix missing cache content on missing title image
							titleImg = (titleImg == null) ? new Image() : titleImg;
						%>
						<td><a href="<%= response.encodeURL("/department.jsp?deptId=" + department+"&trk=dnav") %>"><img src="<%= titleImg.getPath() %>" border="0" width="<%= titleImg.getWidth() %>" height="<%= titleImg.getHeight() %>"></a></td>
						<td>
							<table cellpadding="0" cellspacing="0" border="0">
								<% for ( int rowIndex = 0; rowIndex < maxRows; rowIndex++ ) { %>
								<tr>
									<%
									for ( int colIndex = 0; colIndex < maxCols && ((maxRows * colIndex) + rowIndex) < folderList.size(); colIndex++ ) {
										CategoryModel folder = (CategoryModel)folderList.get((maxRows * colIndex) + rowIndex);
										CategoryModel alias = folder.getAlias();
										String folderLink = null;
										if ( alias != null ) {
											folderLink = FDURLUtil.getCategoryURI(alias.getContentName(), "dnav");
										} else {
											folderLink = FDURLUtil.getCategoryURI(folder.getContentName(), "dnav");
										}

                    if (colIndex == 0) {
										%>
                      <td width="1" bgcolor="#999966"><img src="/media_stat/images/layout/clear.gif" width="1" height="12" border="0"></td>
                    <% } %>
                    <td class="onePxTall"><img src="/media_stat/images/layout/clear.gif" width="5" height="1" alt="" border="0"></td>
										<td class="deptNav"><a href="<%= folderLink %>"><%= folder.getFullName() %></a></td>
				
                    <td class="onePxTall"><img src="/media_stat/images/layout/clear.gif" width="5" height="1" alt="" border="0"></td>
                    <% if (colIndex < maxCols-1) { %>
                      <td width="1" bgcolor="#999966"><img src="/media_stat/images/layout/clear.gif" width="1" height="12" border="0"></td>
                    <% } %>
                  <% } %>
								</tr>
								<% } %>
								<tr class="deptnav-lastrow"><td><img src="/media_stat/images/layout/clear.gif" width="1" height="2" alt="" border="0"></td></tr>
							</table>
						</td>
						<td><img src="/media_stat/images/layout/clear.gif" width="1" height="<%= 13 * maxRows %>" border="0">&nbsp;</td>
					</tr>
				</table>
			</fd:DeptNav>
		<% } catch (Exception ex) {
			ex.printStackTrace();
			%>
			<oscache:usecached />
		<% } %>
	</oscache:cache>
<% }%>
