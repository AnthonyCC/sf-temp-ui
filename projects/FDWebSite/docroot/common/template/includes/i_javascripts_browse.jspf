<%@ page import='com.freshdirect.webapp.taglib.fdstore.*'%>
<%@ page import='com.freshdirect.fdstore.sempixel.FDSemPixelCache' %>
<%@ page import='com.freshdirect.fdstore.sempixel.SemPixelModel' %>
<%@ page import='com.freshdirect.fdstore.FDStoreProperties' %>
<%@ page import='com.freshdirect.fdstore.customer.*' %>
<%@ page import="com.freshdirect.fdstore.rollout.EnumRolloutFeature"%>
<%@ page import="com.freshdirect.fdstore.rollout.FeatureRolloutArbiter"%>
<%@ page import="com.freshdirect.webapp.util.JspMethods" %>
<%@ taglib uri='freshdirect' prefix='fd' %>
<%@ taglib uri="http://jawr.net/tags" prefix="jwr" %>
<%@ taglib uri="fd-features" prefix="features" %>
<%-- this file will be included in the <head> tag --%>
	<%--
		using the same /directory/version/ system as scriptaculous for jquery
		also to avoid conflicts, jQuery's $ will always be set to $jq
	--%>
	
  <%-- Feature version switcher --%>
  <features:potato />
  <script type="text/javascript">
  (function () {
    window.FreshDirect = window.FreshDirect || {};
    var fd = window.FreshDirect;
    
    fd.features = fd.features || {};

    fd.features.active = <fd:ToJSON object="${featuresPotato.active}" noHeaders="true"/>

    fd.properties = fd.properties || {};
    fd.properties.isLightSignupEnabled = <%= FDStoreProperties.isLightSignupEnabled() ? "true" : "false" %>;
    fd.properties.isSocialLoginEnabled = <%= FDStoreProperties.isSocialLoginEnabled() ? "true" : "false" %>;
  
    <% 
    FDSessionUser jsUser = (FDSessionUser)session.getAttribute(SessionName.USER);
    if (jsUser != null) {
      int sessionUserLevel = jsUser.getLevel();
      FDSessionUser sessionUser = (FDSessionUser) jsUser;
      boolean hideZipCheckPopup = (jsUser.getLevel() != FDSessionUser.GUEST || jsUser.isZipCheckPopupUsed() || sessionUser.isZipPopupSeenInSession());
      
      if (!hideZipCheckPopup){
          sessionUser.setZipPopupSeenInSession(true);
      }
     
      String zipCode = jsUser.getZipCode();
      %>
    fd.user = {};
    fd.user.recognized = <%= sessionUserLevel == FDUserI.RECOGNIZED %>;
    fd.user.guest = <%= sessionUserLevel == FDUserI.GUEST %>;
    fd.mobWeb = <%= FeatureRolloutArbiter.isFeatureRolledOut(EnumRolloutFeature.mobweb, jsUser) && JspMethods.isMobile(request.getHeader("User-Agent")) %>;
    fd.user.isZipPopupUsed = <%= hideZipCheckPopup %>;
    fd.user.zipCode = '<%= zipCode %>';
    <% } %>
  }());
  </script>

	<jwr:script src="/fdlibs.js" useRandomParam="false" />
	<fd:javascript src="/assets/javascript/coremetrics.js"/>
	
<%@ include file="/common/template/includes/extol_tags.jspf" %>

  <%-- HTML5 support for IE8 --%>
  <!--[if lt IE 9]>
    <fd:javascript src="/assets/javascript/html5.js"/>
  <![endif]-->
	
	<script type="text/javascript" language="javascript">

		var FD = FreshDirect || {};
		FD.USQLegalWarning = FreshDirect.USQLegalWarning || {};
		FD.USQLegalWarning.sessionStore = '<%=session.getId()%>';
		FD.USQLegalWarning.getJSessionId = FD.USQLegalWarning.getJSessionId || 
      function () { return FD.USQLegalWarning.sessionStore; };

		var $jq;
		var jqInit = false; 
		function initJQuery() {
			if (typeof(jQuery) == 'undefined') {
				if (!jqInit) {
					jqInit = true;
				}
				setTimeout("initJQuery()", 100);
			} else {
				$jq = jQuery.noConflict();
			}
		}
		initJQuery();
	</script>
	
	<script>
	(function ($) {
		$(function () {
			
			$.smartbanner({daysHidden: 0, daysReminder: 0,author:'FreshDirect',button: 'VIEW'});
			if(!$jq('#smartbanner.shown').is(':visible')) { $jq('#smartbanner').show(); }
		
		});
	})($jq);
	</script> 
	
	<jwr:script src="/fdmisc.js" useRandomParam="false" />
	
  <%-- it would be very nice to be able to remove this, but the login box uses "changeType", this may be refactored later --%>
  <fd:javascript src="/assets/javascript/common_javascript.js"/>

	<%
		/* Google Analytics Pixel */
		SemPixelModel semPixel_GA = FDSemPixelCache.getInstance().getSemPixel("GoogleAnalytics");
		semPixel_GA.setParam("GAKey", FDStoreProperties.getGoogleAnalyticsKey());
	%>
	<%
		if(request.getRequestURI().endsWith("referee_signup.jsp") || request.getRequestURI().indexOf("invite") != -1) {
	%>
		<script type="text/javascript">                     
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-20535945-1']);
			_gaq.push(['_setDomainName', '.freshdirect.com']);
			_gaq.push(['_setCustomVar',1,'RAF','Responder',1]);					 
			_gaq.push(['_trackPageview', '/registration/referee_signup.jsp']); 
			_gaq.push(['_setReferrerOverride', '/registration/referee_signup.jsp?utm_medium=internal&utm_source=raf&utm_campaign=raf']);
			(function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();
		</script>
	<% } else { %>
		<fd:SemPixelIncludeMedia pixelNames="GoogleAnalytics" />
	<% } %>
	
	<%
		/* ConvergeTrack Pixel */
		SemPixelModel semPixel_CT = FDSemPixelCache.getInstance().getSemPixel("ConvergeTrack");
	
		//always include this
		semPixel_CT.setParam("landing", "true");
		
		if(session != null && (session.getAttribute("LITESIGNUP_COMPLETE") != null || session.getAttribute("regSuccess") != null)) {
			/* user just completed sign up lite or checkout sign up, add param */
			semPixel_CT.setParam("signUp", "true");

			FDUserI sem_user_CT = (FDUserI)session.getAttribute(SessionName.USER);
			if (sem_user_CT != null) {
				semPixel_CT.setParam("custId", sem_user_CT.getIdentity().getErpCustomerPK().toString());
			}
			session.removeAttribute("regSuccess"); /* remove sign up marker once used, so every other page isn't logged */
			if (request.getRequestURI().equalsIgnoreCase("/index.jsp")) {
				//remove this session attribute
				session.removeAttribute("LITESIGNUP_COMPLETE");
			}
		}

		%><fd:SemPixelIncludeMedia pixelNames="ConvergeTrack" /><%

		//kill params
		semPixel_CT.setParam("signUp", "false");
		semPixel_CT.setParam("landing", "false");
	%>

	<fd:IncludeMedia name="/media/editorial/site_pages/javascript.html"/>
	
	<%
		FDUserI dpTcCheckUser = (FDUserI)session.getAttribute(SessionName.USER);
		FDSessionUser dpTcCheckSessionUser = (FDSessionUser)session.getAttribute(SessionName.USER);

		if (dpTcCheckUser != null && request.getRequestURI().indexOf("brownie_points.jsp") == -1 &&
				(dpTcCheckUser.getLevel() == FDSessionUser.SIGNED_IN && Boolean.FALSE.equals(dpTcCheckSessionUser.hasSeenDpNewTc()) && dpTcCheckUser.isDpNewTcBlocking())
			) {
			%>
				<script type="text/javascript">
		    		$jq(document).ready(function() {
			    		doOverlayWindow('/overlays/delivery_pass_tc.jsp?showButtons=true&count=true');
		    		});
		    	</script>
	    	<%
		}
	%>
	
	  <%-- Bazaarvoice --%>
  
  <% 
  if(FDStoreProperties.isBazaarvoiceEnabled()){
  	String bvapiUrl = FDStoreProperties.getBazaarvoiceBvapiUrl(); %>
  	<script type="text/javascript" src="<%= bvapiUrl %>"></script>
  <% } %>

<script src="/assets/javascript/jquery/jquery_validate/jquery.validate.js"></script>
