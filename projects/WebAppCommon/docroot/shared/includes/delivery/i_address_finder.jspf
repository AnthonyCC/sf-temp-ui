<%@ page import="com.freshdirect.fdstore.util.FDTimeslotUtil" %>
<%@ page import='com.freshdirect.customer.*'%>
<%@ page import="com.freshdirect.webapp.util.JspMethods"%>
<%@ page import="com.freshdirect.webapp.util.CCFormatter"%>
<%@ page import="com.freshdirect.framework.util.NVL"%>
<%@ page import='com.freshdirect.fdstore.customer.FDDeliveryTimeslotModel'%>
<%@ page import='com.freshdirect.fdstore.FDStoreProperties' %>

<% //expanded page dimensions
final int W_ADDRESS_FINDER_TOTAL = 970;
%>

<%
Collection shipToAddresses = new ArrayList();
ErpAddressModel address = null;
int page_type = TimeslotLogic.PAGE_NORMAL;
if(!timeSlotCtx.equals(TimeslotContext.CHECK_AVAIL_SLOTS_NO_USER))
	shipToAddresses = AddressFinder.getShipToAddresses(user);
	address = AddressFinder.getShipToAddress(user, addressId, timeSlotCtx, request);
%>

<%
	String actionPage="";
	if(timeSlotCtx.equals(TimeslotContext.CHECK_AVAILABLE_TIMESLOTS))
		actionPage = "/your_account/delivery_info_avail_slots.jsp";
	else if(timeSlotCtx.equals(TimeslotContext.RESERVE_TIMESLOTS))
		actionPage = "/your_account/reserve_timeslot.jsp";
	else if(timeSlotCtx.equals(TimeslotContext.RESERVE_TIMESLOTS_CRM))
		actionPage = "/customer_account/reserve_timeslot.jsp";
	else 
		actionPage = "/main/delivery_available_slots.jsp";
%>

<img src="/media_stat/images/layout/clear.gif" WIDTH="1" HEIGHT="8" BORDER="0">
<img src="/media_stat/images/layout/clear.gif" WIDTH="1" HEIGHT="8" BORDER="0">

<%@ include file="/shared/includes/i_loyalty_bar.jspf" %> <br/>

<table width="<%=W_ADDRESS_FINDER_TOTAL%>" cellpadding="0" cellspacing="0" border="0">
<%if(!timeSlotCtx.equals(TimeslotContext.CHECK_AVAL_SLOTS_CRM) && !timeSlotCtx.equals(TimeslotContext.CHECK_SLOTS_FOR_ADDRESS_CRM)){%>

			<%if(timeSlotCtx.equals(TimeslotContext.CHECK_AVAILABLE_TIMESLOTS) ||(timeSlotCtx.equals(TimeslotContext.CHECK_AVAIL_SLOTS_NO_USER))){ %>
				<tr>
					<td colspan="3" class="title16">
							<% if (FDStoreProperties.isAdServerEnabled()) { %>
								<SCRIPT LANGUAGE="JavaScript">
								<!--
									OAS_AD('CategoryNote');
									//-->
								</SCRIPT>
							<% } %>
						<table>
							<tr>
								<td class="title16">Available Delivery TimeSlots</td>
								<%if(FDStoreProperties.isNewFDTimeslotGridEnabled()){%>
								<td>
									<fd:IncludeMedia name="/media/editorial/timeslots/msg_timeslots_learnmore.html"/>
								</td>
								<%}%>
							</tr>
						</table>
						<img src="/media_stat/images/layout/clear.gif" width="1" height="3">
					</td>
				</tr>
				<tr>
					<td colspan="3" class="text12">Here are the currently available timeslots for delivery to this address:</td>
				</tr>
			<%} else if(timeSlotCtx.equals(TimeslotContext.RESERVE_TIMESLOTS)){%>
				<tr>
					<td colspan="3" class="title16">
						<table>
							<tr>
								<td class="title16">
									<%=(user != null && user.getReservation() != null) ? "Your Delivery Timeslot Is Reserved" : "Reserve a Delivery Time"%>
								</td>
								<%if(FDStoreProperties.isNewFDTimeslotGridEnabled()){%>
								<td>
									<fd:IncludeMedia name="/media/editorial/timeslots/msg_timeslots_learnmore.html"/>
								</td>
								<%}%>
							</tr>
						</table>
					</td>
				</tr>
				<tr>
					<td colspan="3" class="text12"><%= (user != null && user.getReservation() != null) ? " Displayed below is your current delivery reservation for" : " Displayed below are the timeslots currently available to be reserved for"%>:</td>
				</tr>
				
			<%}else if(timeSlotCtx.equals(TimeslotContext.RESERVE_TIMESLOTS_CRM)){%>
				<tr>
					<td colspan="3" class="text12">Displayed below are the timeslots currently available to be reserved for:</td>
				</tr>
			<%}%>
<%}%>
				<tr>
					<td>&nbsp;</td>
				
			<% 
			if ((shipToAddresses.size() > 1 && !timeSlotCtx.equals(TimeslotContext.CHECK_AVAIL_SLOTS_NO_USER)&&!timeSlotCtx.equals(TimeslotContext.CHECK_SLOTS_FOR_ADDRESS_CRM)) || (timeSlotCtx.equals(TimeslotContext.CHECK_AVAIL_SLOTS_NO_USER) && shipToAddresses.size()>1 && !isCheckAddress)) { 
			%>
					<td class="text12">
						<FORM name="addressForm" method="POST" action="<%= actionPage %>" >
						<img src="/media_stat/images/layout/clear.gif" width="1" height="14"><br/>
						<input type="hidden" value="Y" id="addressChange" name="addressChange" />
						<SELECT name="addressId" onChange="javascript:submit()" CLASS="text12" style="width: 250px;">
							<% 
							for(Iterator saItr=shipToAddresses.iterator();saItr.hasNext();) {
								ErpAddressModel addr = (ErpAddressModel)saItr.next();
								String id = "";
								id = addr.getPK().getId();
							%>
							<OPTION value="<%= id %>" <%= id.equals(address.getPK().getId()) ? "SELECTED" : "" %>>
								<%=addr.getAddress1()%>, <%=addr.getCity()%>, <%=addr.getZipCode()	%>
							</OPTION>
							<% } %>
						</SELECT><br /><br />
						</FORM>
					</td>
					<%if(!timeSlotCtx.equals(TimeslotContext.CHECK_SLOTS_FOR_ADDRESS_CRM) && !timeSlotCtx.equals(TimeslotContext.CHECK_AVAL_SLOTS_CRM)){%>
						<td class="text12">
							<b>Please note that you may only have a delivery timeslot reservation for one address at a time.</b>
						</td>
					<%}%>
				

			<% } else {
				if(address!=null){ %>
					<td class="text12" colspan="2">
						<img src="/media_stat/images/layout/clear.gif" width="1" height="14"><br/>
						<b><%=address.getAddress1()%><br/><%=address.getCity()%> <%=address.getState()%> <%=address.getZipCode()%></b><br/>
						<%if(timeSlotCtx.equals(TimeslotContext.CHECK_AVAIL_SLOTS_NO_USER)){%>
							<a href="/help/delivery_info_check_slots.jsp" class="text11">change address</a>
						<%}else if(timeSlotCtx.equals(TimeslotContext.CHECK_AVAILABLE_TIMESLOTS)){%>
							<a href="/your_account/delivery_info_check_slots.jsp" class="text11">change address</a>
						<%}else if(timeSlotCtx.equals(TimeslotContext.CHECK_SLOTS_FOR_ADDRESS_CRM) && isCheckAddress){%>
							<br/><a href="/main/delivery_available_slots.jsp" class="order_detail">View all addresses for this customer</a>
						<%}%>
					</td>
				<% } %>
			<% } %>
				</tr>

			<%if(!timeSlotCtx.equals(TimeslotContext.CHECK_AVAL_SLOTS_CRM)&&!timeSlotCtx.equals(TimeslotContext.CHECK_SLOTS_FOR_ADDRESS_CRM)){%>
				<tr>
					<td  colspan="3"><img src="/media_stat/images/layout/clear.gif" width="430" height="15"></td>
				</tr>
				<tr>
					<td colspan="3"><img src="/media_stat/images/layout/clear.gif" width="1" height="4"></td>
				</tr>
			<% } %>
</table>


<%
	if(!timeSlotCtx.equals(TimeslotContext.CHECK_AVAL_SLOTS_CRM)&&!timeSlotCtx.equals(TimeslotContext.RESERVE_TIMESLOTS)
		&&!timeSlotCtx.equals(TimeslotContext.CHECK_SLOTS_FOR_ADDRESS_CRM)&& !timeSlotCtx.equals(TimeslotContext.RESERVE_TIMESLOTS_CRM) && user.isEligibleForPreReservation()){
%>

<table width="<%=W_ADDRESS_FINDER_TOTAL%>" cellpadding="0" cellspacing="0" style="border:1px solid #CCCCCC;text-align:center;">

	<tr>
		<td colspan="7">
			<img src="/media_stat/images/layout/clear.gif" width="1" height="2"><br/>
	<% if(user.isEligibleForPreReservation() && (!"true".equals(request.getParameter("chefstable")))) { %>
			
				<table width="100%" style="padding-left: 5px; padding-right: 5px;">
					<tr>
						<td  align="left">
							<font class="text14"><b>Want to Plan Ahead?</b></font><br/>
							<span class="text12">As a Chef's table customer, you may reserve a timeslot ahead of time.</span>
						</td>
						<td align="right">
							<a href="/your_account/reserve_timeslot.jsp" style="text-align:right;">
								<img src="/media_stat/images/template/youraccount/make_a_reservation.gif" width="164" height="24" border="0" alt="Reserve a Delivery Time" vspace="4">
							</a>
						</td>
					</tr>
				<% if (FDStoreProperties.isAdServerEnabled()) { %>
					<tr>
						<SCRIPT LANGUAGE=JavaScript>
							<!--
							OAS_AD('TimeslotBottom');
							//-->
						</SCRIPT><br/>
					 </tr>
				<% } %>
				</table>
			
	<% }else if(!user.isDlvPassActive() && !(user.isEligibleForPreReservation() && (!"true".equals(request.getParameter("chefstable"))))) { %>
			<table width="100%">
				<div align="center">
				<% if (FDStoreProperties.isAdServerEnabled()) { %>
					<SCRIPT LANGUAGE=JavaScript>
						<!--
						OAS_AD('TimeslotBottom');
						//-->
					</SCRIPT><br/><br/>
				<% } %>
				 </div>
			 </table>
	<% } %>
		</td>
	</tr>
	</table>
	<img src="/media_stat/images/layout/clear.gif" width="1" height="12"><br/>

<%}%>



