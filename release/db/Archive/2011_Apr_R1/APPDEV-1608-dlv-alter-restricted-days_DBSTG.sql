
ALTER TABLE DLV.MUNICIPALITY_INFO
add ID VARCHAR2(16);

UPDATE DLV.MUNICIPALITY_INFO SET ID = DLV.SYSTEM_SEQ.NEXTVAL;

ALTER TABLE DLV.MUNICIPALITY_INFO
ADD CONSTRAINT 
MUNICIPALITY_INFO_PK PRIMARY KEY(ID);

ALTER TABLE DLV.RESTRICTED_DAYS
add (HOLIDAY_ID VARCHAR2(32),
DAYS_TO_ADD NUMBER(2));

CREATE TABLE DLV.RESTRICTION_DETAIL
(ID VARCHAR2(16),
 RESTRICTION_ID VARCHAR2(16),
 DAY_OF_WEEK NUMBER(1),
 RES_START_TIME VARCHAR2(15),
 RES_END_TIME VARCHAR2(15),
 CONSTRAINT RESTRICTION_DTL_PK PRIMARY KEY(ID),
 CONSTRAINT RESTRICTED_DAYS_FK FOREIGN KEY(RESTRICTION_ID)
 REFERENCES DLV.RESTRICTED_DAYS(ID));

GRANT SELECT, INSERT, DELETE, UPDATE on DLV.RESTRICTION_DETAIL to FDSTORE_STSTG01;

GRANT SELECT, INSERT, DELETE, UPDATE on DLV.RESTRICTION_DETAIL to APPDEV;

CREATE TABLE DLV.MUNICIPALITY_RESTRICTION_DATA
(ID VARCHAR2(16),
 MUNICIPALITY_ID VARCHAR2(16),
 RESTRICTION_ID VARCHAR2(16),
 CONSTRAINT REGION_RES_DATA_PK PRIMARY KEY(ID),
 CONSTRAINT REGION_RES_DATA_RES_DATA_FK FOREIGN KEY(RESTRICTION_ID)
 REFERENCES DLV.RESTRICTED_DAYS(ID),
 CONSTRAINT REGION_RES_DATA_MUN_INFO_FK FOREIGN KEY(MUNICIPALITY_ID)
 REFERENCES DLV.MUNICIPALITY_INFO(ID));

GRANT SELECT, INSERT, DELETE, UPDATE on DLV.MUNICIPALITY_RESTRICTION_DATA to FDSTORE_STSTG01;

GRANT SELECT on DLV.MUNICIPALITY_RESTRICTION_DATA to APPDEV;

--Migrate existing alcohol restriction to the new tables.
INSERT INTO DLV.RESTRICTION_DETAIL (
   ID, RESTRICTION_ID, DAY_OF_WEEK, 
   RES_START_TIME, RES_END_TIME) 
VALUES ( DLV.SYSTEM_SEQ.nextval,
 (SELECT ID FROM DLV.RESTRICTED_DAYS WHERE TYPE='RRN' and REASON='BER' and DAY_OF_WEEK = 1),
 1,'12:00 AM','08:00 AM');
 
 INSERT INTO DLV.RESTRICTION_DETAIL (
   ID, RESTRICTION_ID, DAY_OF_WEEK, 
   RES_START_TIME, RES_END_TIME) 
VALUES ( DLV.SYSTEM_SEQ.nextval,
 (SELECT ID FROM DLV.RESTRICTED_DAYS WHERE TYPE='RRN' and REASON='WIN' and DAY_OF_WEEK = 1),
 1,'12:00 AM','12:00 PM');
 
 --Create Mapping between municipality info and restriction tables.
 INSERT INTO DLV.MUNICIPALITY_RESTRICTION_DATA (
   ID, MUNICIPALITY_ID, RESTRICTION_ID) 
VALUES ( DLV.SYSTEM_SEQ.nextval,
 (SELECT ID FROM DLV.MUNICIPALITY_INFO WHERE STATE='NY' and COUNTY IS NULL),
 (SELECT ID FROM DLV.RESTRICTED_DAYS WHERE TYPE='RRN' and REASON='BER' and DAY_OF_WEEK = 1));

 INSERT INTO DLV.MUNICIPALITY_RESTRICTION_DATA (
   ID, MUNICIPALITY_ID, RESTRICTION_ID) 
VALUES ( DLV.SYSTEM_SEQ.nextval,
 (SELECT ID FROM DLV.MUNICIPALITY_INFO WHERE STATE='NY' and COUNTY IS NULL),
 (SELECT ID FROM DLV.RESTRICTED_DAYS WHERE TYPE='RRN' and REASON='WIN' and DAY_OF_WEEK = 1));
